# yaml-language-server: $schema=./task-schema.json
epic: D1_Web_Deployment
feature: Vercel_Production_Deployment
context:
  phase: 1
  spec_refs:
    - "Docs: docs/WEB_DEPLOYMENT_PLAN.md"
    - "Docs: docs/ARCHITECTURE.md"
    - "Config: vercel.json (deployment configuration)"
  notes: >
    Deploy the Social Graph Connector web application to Vercel production.
    This is a CAREFUL, non-destructive deployment that preserves all existing
    functionality. Vercel will auto-detect React/Vite and deploy the frontend,
    with Express backend as serverless functions. We will verify everything works
    before and after deployment, and ensure we don't break any existing functionality.
defaults:
  status: todo
  priority: high
  owner: engineering
  envs: [prod]

tasks:
  # ============================================================================
  # PHASE 1: Pre-Deployment Verification & Safety Checks
  # ============================================================================

  - id: D1_T1_verify_current_state
    title: "Verify current application state and backup configuration"
    type: chore
    status: todo
    priority: critical
    description: >
      Before making any changes, verify the current state of the application.
      Document what's working, check git status, and ensure we have a rollback plan.
      This is a SAFETY CHECK to ensure we don't break anything.
    code_areas:
      - "config: vercel.json"
      - "config: package.json"
      - "config: environment variables"
    acceptance_criteria:
      - "Git repository is clean (no uncommitted changes)"
      - "Current Vercel configuration is documented"
      - "All environment variables are listed and documented"
      - "Current deployment status is known (if any)"
      - "Backup plan is documented"
    tests:
      - "Manual: Run `git status` - should be clean"
      - "Manual: Document current vercel.json settings (if exists)"
      - "Manual: List all Vercel Environment Variables (screenshot/document)"
      - "Manual: Test app locally with `npm run dev` - verify it works"

  - id: D1_T2_verify_build_process
    title: "Verify production build works locally"
    type: chore
    status: todo
    priority: critical
    description: >
      Test the production build process locally to ensure it works before deploying.
      This catches any build issues before they hit production.
    code_areas:
      - "build: npm run build"
      - "build: npm start"
    acceptance_criteria:
      - "`npm run build` completes successfully"
      - "`dist/` folder is created with expected structure"
      - "`dist/index.js` exists (server bundle)"
      - "`dist/public/` exists (client bundle)"
      - "`npm start` runs without errors"
      - "Production build serves on port 5000"
      - "App loads in browser at http://localhost:5000"
    tests:
      - "Manual: Run `npm run build` - should succeed"
      - "Manual: Verify `dist/` folder structure"
      - "Manual: Run `npm start` - should start server"
      - "Manual: Visit http://localhost:5000 - app should load"
      - "Manual: Test login/signup flow"
      - "Manual: Test core features (if possible without full env)"

  - id: D1_T3_verify_environment_variables
    title: "Verify all required environment variables are documented for Vercel"
    type: chore
    status: todo
    priority: critical
    description: >
      Check that all required environment variables are documented for Vercel.
      Document what's needed and prepare to set them in Vercel Dashboard.
      DO NOT set them yet - we'll do that during deployment.
    code_areas:
      - "config: Vercel Environment Variables"
      - "docs: Environment variable requirements"
    acceptance_criteria:
      - "All required frontend vars are documented (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)"
      - "All required backend vars are documented (SUPABASE_SERVICE_ROLE_KEY)"
      - "Optional vars are documented (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)"
      - "Missing vars are identified and documented"
      - "Environment variable list is ready for Vercel Dashboard"
    tests:
      - "Manual: List all required environment variables"
      - "Manual: Verify VITE_SUPABASE_URL is documented"
      - "Manual: Verify VITE_SUPABASE_ANON_KEY is documented"
      - "Manual: Verify SUPABASE_SERVICE_ROLE_KEY is documented"
      - "Manual: Document any missing variables"
      - "Manual: Create checklist for Vercel Dashboard setup"

  - id: D1_T4_create_vercel_config
    title: "Create vercel.json configuration file"
    type: chore
    status: todo
    priority: high
    description: >
      Create vercel.json configuration file for Vercel deployment.
      Configure build settings, routes, and serverless functions for Express backend.
      Vercel auto-detects React/Vite, but we need to configure the Express API routes.
    code_areas:
      - "config: vercel.json"
    acceptance_criteria:
      - "vercel.json file is created"
      - "Build command is 'npm run build' (correct)"
      - "Output directory is 'dist/public' (Vite build output)"
      - "Express serverless functions are configured correctly"
      - "API routes are properly routed"
      - "Environment variables are referenced correctly"
    tests:
      - "Manual: Create vercel.json with proper configuration"
      - "Manual: Verify build command matches package.json"
      - "Manual: Verify output directory matches Vite config"
      - "Manual: Test vercel.json syntax (if tool available)"

  # ============================================================================
  # PHASE 2: Pre-Deployment Configuration (Minimal Changes)
  # ============================================================================

  - id: D1_T5_prepare_oauth_callbacks
    title: "Prepare OAuth callback URLs for Vercel deployment"
    type: chore
    status: todo
    priority: high
    description: >
      Prepare Google OAuth callback URLs for Vercel deployment.
      Vercel will provide a deployment URL (e.g., your-app.vercel.app).
      We'll need to update the callback URL in Google Cloud Console after deployment.
    code_areas:
      - "config: Google Cloud Console"
      - "config: OAuth redirect URIs"
    acceptance_criteria:
      - "Current OAuth callback URLs are documented"
      - "Plan for Vercel callback URL is documented"
      - "Google Cloud Console OAuth credentials page is located"
      - "Instructions for updating callback URL are prepared"
    tests:
      - "Manual: Check Google Cloud Console → OAuth credentials"
      - "Manual: Document current callback URLs"
      - "Manual: Document Vercel callback URL format (https://your-app.vercel.app/auth/google/callback)"
      - "Manual: Prepare steps to add callback URL after deployment"

  - id: D1_T6_verify_edge_functions
    title: "Verify Supabase Edge Functions are deployed"
    type: chore
    status: todo
    priority: high
    description: >
      Verify that all required Edge Functions are deployed to Supabase.
      These should already be deployed via GitHub Actions, but verify.
    code_areas:
      - "infra: Supabase Edge Functions"
    acceptance_criteria:
      - "All required Edge Functions are deployed"
      - "Edge Function secrets are set (OPENAI_API_KEY, etc.)"
      - "Functions are accessible and responding"
    tests:
      - "Manual: Check Supabase Dashboard → Edge Functions"
      - "Manual: Verify functions: extract-entities, generate-matches, transcribe-audio, etc."
      - "Manual: Test function invocation (if possible)"

  # ============================================================================
  # PHASE 3: Deployment (Vercel)
  # ============================================================================

  - id: D1_T7_setup_vercel_project
    title: "Set up Vercel project and connect GitHub repository"
    type: chore
    status: todo
    priority: critical
    description: >
      Connect the GitHub repository to Vercel. This enables automatic deployments
      on every push to main/master. Set up the project with proper settings.
    code_areas:
      - "deploy: Vercel project setup"
      - "config: GitHub integration"
    acceptance_criteria:
      - "Vercel account is created/logged in"
      - "GitHub repository is connected to Vercel"
      - "Project is created in Vercel Dashboard"
      - "Project settings are configured correctly"
      - "Auto-deployments are enabled"
    tests:
      - "Manual: Go to vercel.com and sign in"
      - "Manual: Click 'Add New Project'"
      - "Manual: Import repository 'jwitts1998/SOCIAL_GRAPH_JACKSON'"
      - "Manual: Configure project settings (framework preset: Vite)"
      - "Manual: Verify root directory is correct"
      - "Manual: Enable automatic deployments"

  - id: D1_T8_configure_environment_variables
    title: "Configure environment variables in Vercel Dashboard"
    type: chore
    status: todo
    priority: critical
    description: >
      Set all required environment variables in Vercel Dashboard.
      Variables are set per-environment (Production, Preview, Development).
      Set them for Production and Preview environments.
    code_areas:
      - "config: Vercel Environment Variables"
    acceptance_criteria:
      - "All required frontend vars are set (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)"
      - "All required backend vars are set (SUPABASE_SERVICE_ROLE_KEY)"
      - "Optional vars are set (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET if applicable)"
      - "Variables are set for Production and Preview environments"
      - "No secrets are committed to git"
    tests:
      - "Manual: Go to Vercel Dashboard → Project Settings → Environment Variables"
      - "Manual: Add VITE_SUPABASE_URL for Production and Preview"
      - "Manual: Add VITE_SUPABASE_ANON_KEY for Production and Preview"
      - "Manual: Add SUPABASE_SERVICE_ROLE_KEY for Production and Preview"
      - "Manual: Add GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET if needed"
      - "Manual: Verify all variables are encrypted"

  - id: D1_T9_deploy_to_vercel
    title: "Deploy application to Vercel"
    type: deployment
    status: todo
    priority: critical
    description: >
      Deploy the application to Vercel. This will trigger automatically when
      the repository is connected, or can be triggered manually. Vercel will
      run `npm run build` and deploy the frontend + serverless functions.
      Monitor the deployment for any errors.
    code_areas:
      - "deploy: Vercel deployment"
      - "config: vercel.json"
    acceptance_criteria:
      - "Deployment is initiated (automatic or manual)"
      - "Build process completes successfully"
      - "Deployment completes without errors"
      - "Deployment URL is obtained (e.g., your-app.vercel.app)"
      - "Deployment logs show no errors"
    tests:
      - "Manual: Trigger deployment (push to main or manual deploy)"
      - "Manual: Monitor build logs in Vercel Dashboard"
      - "Manual: Verify 'npm run build' runs successfully"
      - "Manual: Verify deployment completes"
      - "Manual: Copy deployment URL"
      - "Manual: Document deployment URL"

  - id: D1_T10_update_oauth_callbacks
    title: "Update OAuth callback URLs in Google Cloud Console"
    type: chore
    status: todo
    priority: high
    description: >
      After deployment, update the Google OAuth callback URL to include the
      Vercel deployment URL. This enables OAuth flows to work in production.
    code_areas:
      - "config: Google Cloud Console"
      - "config: OAuth redirect URIs"
    acceptance_criteria:
      - "Vercel deployment URL is obtained"
      - "Callback URL is added to Google Cloud Console"
      - "Callback URL format is correct (https://your-app.vercel.app/auth/google/callback)"
      - "OAuth flow is tested after update"
    tests:
      - "Manual: Go to Google Cloud Console → OAuth credentials"
      - "Manual: Add new callback URL: https://[your-app].vercel.app/auth/google/callback"
      - "Manual: Save changes"
      - "Manual: Document callback URL for future reference"

  - id: D1_T11_verify_deployment_health
    title: "Verify deployment is healthy and accessible"
    type: test
    status: todo
    priority: critical
    description: >
      After deployment, verify the application is accessible and healthy.
      Check that the deployment URL works, SSL is active, and basic pages load.
      Vercel provides free SSL automatically.
    code_areas:
      - "deploy: Health checks"
      - "deploy: SSL verification"
    acceptance_criteria:
      - "Deployment URL is accessible (HTTPS)"
      - "SSL certificate is valid (automatic with Vercel)"
      - "Home page loads without errors"
      - "No console errors in browser"
      - "API endpoints respond (if testable)"
    tests:
      - "Manual: Visit deployment URL in browser"
      - "Manual: Verify HTTPS (lock icon) - Vercel provides this automatically"
      - "Manual: Check browser console for errors"
      - "Manual: Test home page loads"
      - "Manual: Test login page loads"

  # ============================================================================
  # PHASE 4: Post-Deployment Verification
  # ============================================================================

  - id: D1_T12_test_authentication
    title: "Test authentication flows"
    type: test
    status: todo
    priority: critical
    description: >
      Test user authentication flows to ensure they work in production.
      Test signup, login, logout, and password reset if applicable.
    code_areas:
      - "feature: Authentication"
      - "feature: Supabase Auth"
    acceptance_criteria:
      - "User signup works"
      - "User login works"
      - "User logout works"
      - "Session persists correctly"
      - "Protected routes are protected"
    tests:
      - "Manual: Test user signup with new email"
      - "Manual: Test user login with existing account"
      - "Manual: Test user logout"
      - "Manual: Verify protected routes require auth"
      - "Manual: Test session persistence (refresh page)"

  - id: D1_T13_test_core_features
    title: "Test core application features"
    type: test
    status: todo
    priority: high
    description: >
      Test the core features of the application to ensure everything works
      in production. This includes conversation recording, contact management,
      matching, etc. Test as many features as possible.
    code_areas:
      - "feature: Conversation recording"
      - "feature: Contact management"
      - "feature: Matching"
      - "feature: Edge Functions"
    acceptance_criteria:
      - "Conversation recording works (if testable)"
      - "Contact CRUD operations work"
      - "Matching generation works (if testable)"
      - "Edge Functions are invoked successfully"
      - "Real-time features work (if applicable)"
    tests:
      - "Manual: Test contact list page loads"
      - "Manual: Test contact creation"
      - "Manual: Test contact editing"
      - "Manual: Test conversation history loads"
      - "Manual: Test any other core features"

  - id: D1_T14_test_oauth_integration
    title: "Test Google OAuth integration (if applicable)"
    type: test
    status: todo
    priority: medium
    description: >
      If Google Calendar integration is enabled, test the OAuth flow.
      Verify the callback URL is correct and the flow completes successfully.
    code_areas:
      - "feature: Google OAuth"
      - "feature: Google Calendar"
    acceptance_criteria:
      - "Google OAuth flow initiates correctly"
      - "OAuth callback is received"
      - "Tokens are stored correctly"
      - "Calendar sync works (if testable)"
    tests:
      - "Manual: Test 'Connect Calendar' button (if present)"
      - "Manual: Complete OAuth flow"
      - "Manual: Verify callback URL matches deployment URL"
      - "Manual: Test calendar sync (if applicable)"

  - id: D1_T15_verify_environment_variables_production
    title: "Verify environment variables work in production"
    type: test
    status: todo
    priority: high
    description: >
      Verify that all environment variables are correctly loaded in production.
      Check that Supabase connections work, API keys are valid, etc.
    code_areas:
      - "config: Environment variables"
      - "config: Supabase connection"
    acceptance_criteria:
      - "Supabase connection works (no connection errors)"
      - "Frontend can connect to Supabase"
      - "Backend can connect to Supabase"
      - "API keys are valid (no 401/403 errors)"
    tests:
      - "Manual: Check browser console for Supabase connection errors"
      - "Manual: Check server logs for connection errors"
      - "Manual: Verify data loads from Supabase"
      - "Manual: Verify writes to Supabase work"

  - id: D1_T16_performance_check
    title: "Check production performance and load times"
    type: test
    status: todo
    priority: medium
    description: >
      Check that the production deployment performs well. Verify load times
      are acceptable and there are no obvious performance issues.
    code_areas:
      - "deploy: Performance"
      - "deploy: Load times"
    acceptance_criteria:
      - "Initial page load is < 5 seconds"
      - "No obvious performance issues"
      - "Assets load correctly (CSS, JS, images)"
      - "No 404 errors for assets"
    tests:
      - "Manual: Measure initial page load time"
      - "Manual: Check Network tab for slow requests"
      - "Manual: Verify all assets load (no 404s)"
      - "Manual: Test on different browsers if possible"

  # ============================================================================
  # PHASE 5: Documentation & Cleanup
  # ============================================================================

  - id: D1_T16_document_deployment
    title: "Document deployment details and URLs"
    type: docs
    status: todo
    priority: medium
    description: >
      Document the deployment URL, configuration, and any important notes.
      This helps with future deployments and troubleshooting.
    code_areas:
      - "docs: Deployment documentation"
    acceptance_criteria:
      - "Deployment URL is documented"
      - "Deployment date/time is recorded"
      - "Configuration notes are documented"
      - "Any issues encountered are documented"
    tests:
      - "Manual: Update docs/WEB_DEPLOYMENT_PLAN.md with Vercel deployment URL"
      - "Manual: Document deployment date"
      - "Manual: Document Vercel project settings and configuration"
      - "Manual: Document any environment variable changes made"

  - id: D1_T17_setup_monitoring
    title: "Set up basic monitoring and alerts (optional)"
    type: chore
    status: todo
    priority: low
    description: >
      Set up basic monitoring for the deployment. Vercel has built-in
      monitoring and analytics. Document how to check logs and monitor the deployment.
    code_areas:
      - "deploy: Monitoring"
      - "deploy: Logging"
    acceptance_criteria:
      - "Monitoring setup is documented"
      - "Log access is documented"
      - "Alert setup is documented (if applicable)"
    tests:
      - "Manual: Document how to access Vercel logs (Dashboard → Deployments → Logs)"
      - "Manual: Document how to monitor deployment health"
      - "Manual: Set up Vercel Analytics if desired"

  # ============================================================================
  # PHASE 6: Rollback Plan (If Needed)
  # ============================================================================

  - id: D1_T18_document_rollback_procedure
    title: "Document rollback procedure"
    type: docs
    status: todo
    priority: medium
    description: >
      Document how to rollback the deployment if something goes wrong.
      This should be done BEFORE deployment, but can be updated after.
    code_areas:
      - "deploy: Rollback procedure"
    acceptance_criteria:
      - "Rollback procedure is documented"
      - "Steps are clear and testable"
      - "Rollback triggers are defined"
    tests:
      - "Manual: Document steps to rollback deployment"
      - "Manual: Document how to revert to previous version"
      - "Manual: Test rollback procedure (if safe to do so)"

